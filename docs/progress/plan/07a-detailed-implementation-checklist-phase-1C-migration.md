---
**–ù–∞–≤–∏–≥–∞—Ü–∏—è:** [‚Üê –ü—Ä–µ–¥—ã–¥—É—â–∏–π —Ä–∞–∑–¥–µ–ª](07-detailed-implementation-checklist-phase-1C.md) | [–û–≥–ª–∞–≤–ª–µ–Ω–∏–µ](00-TOC.md) | [–°–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑–¥–µ–ª ‚Üí](08-detailed-implementation-checklist-phase-1D.md)
---

### –§–∞–∑–∞ 1C-Migration: –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö v2.0 ‚Üí v2.1 (1-2 –¥–Ω—è) ‚è≥

> **–¶–µ–ª—å:** –ë–µ–∑–æ–ø–∞—Å–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –¥–∞–Ω–Ω—ã—Ö ArangoDB —Å v2.0 –Ω–∞ v2.1
> **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –í—ã—Å–æ–∫–∏–π (–±–ª–æ–∫–∏—Ä—É–µ—Ç –¥–∞–ª—å–Ω–µ–π—à—É—é —Ä–∞–∑—Ä–∞–±–æ—Ç–∫—É)
> **–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:**
> - –§–∞–∑–∞ 1C (MCP-Arango Setup) –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–∞
> - –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ —Å—Ö–µ–º–µ –ë–î –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–∞

#### –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –º–∏–≥—Ä–∞—Ü–∏–∏
- [ ] –°–æ–∑–¥–∞—Ç—å `backend/mcp-arango/migrations/` –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
- [ ] –°–æ–∑–¥–∞—Ç—å –∫–æ–ª–ª–µ–∫—Ü–∏—é `migrations` –≤ ArangoDB –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è:
  ```json
  {
    "_key": "migration_uuid",
    "description": "Remove parent_doc_id from sections",
    "version_from": "2.0",
    "version_to": "2.1",
    "executed_at": "2025-12-17T21:00:00Z",
    "status": "success",
    "affected_docs_count": 15,
    "execution_time_ms": 234,
    "executed_by": "cline_mcp"
  }
  ```
- [ ] –°–æ–∑–¥–∞—Ç—å backup-—Å–∫—Ä–∏–ø—Ç:
  ```bash
  npm run db:backup
  ```

#### –ú–∏–≥—Ä–∞—Ü–∏—è 1: –£–¥–∞–ª–∏—Ç—å parent_doc_id –∏–∑ sections
- [ ] –°–æ–∑–¥–∞—Ç—å `migrations/v2.0-to-v2.1-remove-parent-doc-id.aql`
- [ ] Dry-run –º–∏–≥—Ä–∞—Ü–∏–∏ (–ø–æ–∫–∞–∑–∞—Ç—å, —á—Ç–æ –±—É–¥–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–æ):
  ```aql
  FOR s IN sections
    FILTER s.parent_doc_id != null
    RETURN {
      _key: s._key,
      title: s.title,
      parent_doc_id_to_remove: s.parent_doc_id
    }
  ```
- [ ] –í—ã–ø–æ–ª–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é:
  ```aql
  FOR s IN sections
    FILTER s.parent_doc_id != null
    UPDATE s WITH {parent_doc_id: null} IN sections
    OPTIONS {keepNull: false}
    RETURN {updated: OLD._key, removed_field: OLD.parent_doc_id}
  ```
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç: –Ω–∏ —É –æ–¥–Ω–æ–π section –Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–ª—è `parent_doc_id`
- [ ] –ó–∞–ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –≤ –∫–æ–ª–ª–µ–∫—Ü–∏—é `migrations`

#### –ú–∏–≥—Ä–∞—Ü–∏—è 2: –°–æ–∑–¥–∞—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –∏–Ω–¥–µ–∫—Å—ã
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –∏–Ω–¥–µ–∫—Å—ã —á–µ—Ä–µ–∑ MCP:
  ```
  User: "–ü–æ–∫–∞–∂–∏ –≤—Å–µ –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –∫–æ–ª–ª–µ–∫—Ü–∏–∏ atoms"
  ```
- [ ] –°–æ–∑–¥–∞—Ç—å –∏–Ω–¥–µ–∫—Å `atoms.status` (–µ—Å–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç):
  ```javascript
  db.atoms.ensureIndex({ type: "persistent", fields: ["status"] });
  ```
- [ ] –°–æ–∑–¥–∞—Ç—å –∏–Ω–¥–µ–∫—Å `proposal_links._to` (–µ—Å–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç):
  ```javascript
  db.proposal_links.ensureIndex({ type: "persistent", fields: ["_to"] });
  ```
- [ ] –°–æ–∑–¥–∞—Ç—å –∏–Ω–¥–µ–∫—Å `atoms.locked_by` sparse (–µ—Å–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç):
  ```javascript
  db.atoms.ensureIndex({ type: "persistent", fields: ["locked_by"], sparse: true });
  ```

#### –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏
- [ ] –ó–∞–ø—É—Å—Ç–∏—Ç—å validation script —á–µ—Ä–µ–∑ MCP:
  ```
  User: "–ü—Ä–æ–≤–µ—Ä—å —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –≥—Ä–∞—Ñ–∞"
  Cline ‚Üí arango_validate_graph()
  ```
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ `docs -> atoms` —Å–≤—è–∑–µ–π:
  ```aql
  FOR edge IN structure_links
    FILTER STARTS_WITH(edge._from, 'docs/')
    FILTER STARTS_WITH(edge._to, 'atoms/')
    RETURN edge
  // –î–æ–ª–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤
  ```
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Single Parent Invariant:
  ```aql
  FOR atom IN atoms
    LET incoming = (
      FOR v, e IN INBOUND atom structure_links
        FILTER e.type == "contains"
        RETURN 1
    )
    FILTER LENGTH(incoming) > 1
    RETURN {
      atom_id: atom._key,
      parents_count: LENGTH(incoming),
      issue: "Multiple parents detected"
    }
  // –î–æ–ª–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤
  ```

#### Rollback Plan (–Ω–∞ —Å–ª—É—á–∞–π –ø—Ä–æ–±–ª–µ–º)
- [ ] –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ü–µ–¥—É—Ä—É –æ—Ç–∫–∞—Ç–∞:
  1. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã (n8n, frontend)
  2. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ë–î –∏–∑ backup
  3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å—ã
  4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ backup –Ω–∞ —Ç–µ—Å—Ç–æ–≤–æ–º –æ–∫—Ä—É–∂–µ–Ω–∏–∏

#### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- [ ] –û–±–Ω–æ–≤–∏—Ç—å `docs/mcp-arango.md` —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ –º–∏–≥—Ä–∞—Ü–∏–π
- [ ] –°–æ–∑–¥–∞—Ç—å `backend/mcp-arango/migrations/README.md` —Å:
  - –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏ –ø–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é –º–∏–≥—Ä–∞—Ü–∏–π
  - –°–ø–∏—Å–∫–æ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –º–∏–≥—Ä–∞—Ü–∏–π
  - –ü—Ä–æ—Ü–µ–¥—É—Ä–æ–π rollback
- [ ] –û–±–Ω–æ–≤–∏—Ç—å `CHANGELOG.md` —Å –∑–∞–ø–∏—Å—å—é –æ –º–∏–≥—Ä–∞—Ü–∏–∏ v2.0 ‚Üí v2.1

#### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- [ ] –î–æ–±–∞–≤–∏—Ç—å MCP tool `arango_list_migrations()` –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏—Å—Ç–æ—Ä–∏–∏:
  ```
  User: "–ü–æ–∫–∞–∂–∏ –∏—Å—Ç–æ—Ä–∏—é –º–∏–≥—Ä–∞—Ü–∏–π"
  Cline ‚Üí arango_list_migrations()
  ```
- [ ] –î–æ–±–∞–≤–∏—Ç—å MCP tool `arango_migration_status()` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è:
  ```
  User: "–ö–∞–∫–∞—è –≤–µ—Ä—Å–∏—è —Å—Ö–µ–º—ã —Å–µ–π—á–∞—Å –≤ –ë–î?"
  Cline ‚Üí arango_migration_status()
  ‚Üí –û—Ç–≤–µ—Ç: Current schema version: 2.1
  ```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ (–ø—Ä–∏–º–µ—Ä—ã):**

```bash
# 1. –°–æ–∑–¥–∞—Ç—å backup
User: "–°–¥–µ–ª–∞–π backup –ë–î –ø–µ—Ä–µ–¥ –º–∏–≥—Ä–∞—Ü–∏–µ–π"
Cline ‚Üí –≤—ã–ø–æ–ª–Ω—è–µ—Ç backup-—Å–∫—Ä–∏–ø—Ç

# 2. Dry-run –º–∏–≥—Ä–∞—Ü–∏–∏
User: "–ü–æ–∫–∞–∂–∏, —á—Ç–æ –∏–∑–º–µ–Ω–∏—Ç –º–∏–≥—Ä–∞—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è parent_doc_id"
Cline ‚Üí –∑–∞–ø—É—Å–∫–∞–µ—Ç dry-run AQL

# 3. –í—ã–ø–æ–ª–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
User: "–ó–∞–ø—É—Å—Ç–∏ –º–∏–≥—Ä–∞—Ü–∏—é —É–¥–∞–ª–µ–Ω–∏—è parent_doc_id"
Cline ‚Üí MCP-Arango ‚Üí –≤—ã–ø–æ–ª–Ω—è–µ—Ç –º–∏–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π AQL

# 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
User: "–ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ parent_doc_id —É–¥–∞–ª–µ–Ω –∏–∑ –≤—Å–µ—Ö sections"
Cline ‚Üí MCP-Arango ‚Üí arango_query(...)

# 5. –í–∞–ª–∏–¥–∞—Ü–∏—è
User: "–ü—Ä–æ–≤–µ—Ä—å —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –≥—Ä–∞—Ñ–∞ –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏"
Cline ‚Üí MCP-Arango ‚Üí arango_validate_graph()
```

**‚ö†Ô∏è –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ:**
- –í—Å–µ–≥–¥–∞ —Å–æ–∑–¥–∞–≤–∞–π—Ç–µ backup –ø–µ—Ä–µ–¥ –º–∏–≥—Ä–∞—Ü–∏–µ–π
- –¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é –Ω–∞ –∫–æ–ø–∏–∏ –ë–î –ø–µ—Ä–µ–¥ prod
- –õ–æ–≥–∏—Ä—É–π—Ç–µ –≤—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–ª—è —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∏
- –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ rollback –ø—Ä–æ—Ü–µ–¥—É—Ä—É

**üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:**
- –ú–∏–≥—Ä–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è —á–µ—Ä–µ–∑ MCP-—Å–µ—Ä–≤–µ—Ä (–∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ)
- –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è
- –ï—Å—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–∫–∞—Ç–∞ —á–µ—Ä–µ–∑ backup
- Validation script –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏

---
**–ù–∞–≤–∏–≥–∞—Ü–∏—è:** [‚Üê –ü—Ä–µ–¥—ã–¥—É—â–∏–π —Ä–∞–∑–¥–µ–ª](07-detailed-implementation-checklist-phase-1C.md) | [–û–≥–ª–∞–≤–ª–µ–Ω–∏–µ](00-TOC.md) | [–°–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑–¥–µ–ª ‚Üí](08-detailed-implementation-checklist-phase-1D.md)
---
